{% extends 'reservation/base.html' %}

{% load static %}

{% block head %}
    <style>
        .calender-container {
            height: 80vh;
        }

        .fc-event {
            cursor: pointer
        }
    </style>

    <!-- FullCalendar -->
    <link rel="stylesheet" href="{% static 'reservation/fullcalendar/core/main.min.css' %}">
    <link rel="stylesheet" href="{% static 'reservation/fullcalendar/daygrid/main.min.css' %}">
    <link rel="stylesheet" href="{% static 'reservation/fullcalendar/timegrid/main.min.css' %}">
    <link rel="stylesheet" href="{% static 'reservation/fullcalendar/bootstrap/main.min.css' %}">
{% endblock head %}

{% block navbar %}
    <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="carDropdown" role="button" data-toggle="dropdown"
           aria-haspopup="true" aria-expanded="false">
            {{ current_car.name }}
        </a>
        <div class="dropdown-menu" aria-labelledby="carDropdown">
            {% for car in cars %}
                {% if car == current_car %}
                    <b><a class="dropdown-item" href="{% url 'reservation:calendar_car' car.id %}">
                        {{ car.name }}
                    </a></b>
                {% else %}
                    <a class="dropdown-item" href="{% url 'reservation:calendar_car' car.id %}">
                        {{ car.name }}
                    </a>
                {% endif %}
            {% endfor %}
        </div>
    </li>
{% endblock navbar %}

{% block body %}
    <div class="row justify-content-between">
        <div class="col">
            <h1>{{ current_car.name }}
                <a class="btn btn-secondary" href="{% url 'reservation:calendar_car_config' current_car.id %}">
                    <i class="fas fa-sliders-h"></i>
                </a>
            </h1>
        </div>
        <div class="float-right">
            <button class="btn btn-primary" id="prev-week" onclick="calendar.prev()">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="btn btn-primary" id="next-week" onclick="calendar.next()">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
    <div class="calender-container">
        <div id="calendar"></div>
    </div>
{% endblock body %}

{% block script %}
    <script src="{% static 'reservation/fullcalendar/core/main.min.js' %}"></script>
    <script src="{% static 'reservation/fullcalendar/interaction/main.min.js' %}"></script>
    <script src="{% static 'reservation/fullcalendar/daygrid/main.min.js' %}"></script>
    <script src="{% static 'reservation/fullcalendar/timegrid/main.min.js' %}"></script>
    <script src="{% static 'reservation/fullcalendar/bootstrap/main.min.js' %}"></script>

    <script>

        let currentCarId = {{ current_car.id }};
        let calendarEl = $("#calendar").get(0);
        let calendar = new FullCalendar.Calendar(calendarEl, {
            plugins: ['interaction', 'timeGrid', 'bootstrap'],
            defaultView: 'timeGridWeek',
            themeSystem: 'bootstrap',

            header: {
                left: '',
                center: '',
                right: ''
            },
            allDaySlot: false,

            slotLabelFormat: {
                hour: '2-digit',
                minute: '2-digit'
            },
            eventTimeFormat: {
                hour: '2-digit',
                minute: '2-digit'
            },
            locale: 'be',

            editable: true,
            eventStartEditable: false,
            eventDurationEditable: false,

            firstDay: 1,

            dateClick: function (dateClickInfo) {
                window.open(
                    '/car/' + currentCarId + '/reservation/add?time=' + (dateClickInfo.date.getTime() / 1000),
                    "_self"
                )
            },

            nowIndicator: true,
            height: 'parent',

            eventSources: [
                function (info, successCallback, failureCallback) {
                    $.ajax({
                        dataType: 'json',
                        type: 'get',
                        url: '/api/car/' + currentCarId + '/reservations/',
                        data: {start: info.startStr, end: info.endStr},
                        error: function (xhr) {
                            failureCallback(xhr);
                        },
                        success: function (events) {
                            let calendarEvents = [];
                            for (let i in events) {
                                let e = events[i];
                                let eventObject = {
                                    id: e.id,
                                    start: new Date(e.start_time),
                                    end: new Date(e.end_time),
                                    url: '/reservation/' + e.id
                                };
                                eventObject.backgroundColor = e.owner.profile.calendar_color;
                                eventObject.borderColor = e.owner.profile.calendar_color;
                                eventObject.title = capitalizeFirstLetter(e.owner.username) + '\n';
                                eventObject.title += capitalizeFirstLetter(e.location) + ' Â· ' + e.distance + ' km \n';
                                calendarEvents.push(eventObject);
                            }
                            successCallback(calendarEvents);
                        }
                    });
                }, function (info, successCallback, failureCallback) {
                    $.ajax({
                        dataType: 'json',
                        type: 'get',
                        url: '/api/car/' + currentCarId + '/charging_reservations/',
                        data: {start: info.startStr, end: info.endStr},
                        error: function (xhr) {
                            failureCallback(xhr);
                        },
                        success: function (events) {
                            let calendarEvents = [];
                            for (let i in events) {
                                let e = events[i];
                                let eventObject = {
                                    id: e.id,
                                    start: new Date(e.start_time),
                                    end: new Date(e.end_time),
                                    url: '/charging_reservation/' + e.id
                                };
                                eventObject.backgroundColor = '#868e96';
                                eventObject.borderColor = '#868e96';
                                eventObject.title = 'Charging';
                                calendarEvents.push(eventObject);
                            }
                            successCallback(calendarEvents);
                        }
                    });
                }
            ]
        })
        calendar.render();

    </script>
{% endblock script %}

